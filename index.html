<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ABN-CoalDumping-Logbook</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-tap:active { transform: scale(0.95); }
        ::-webkit-scrollbar { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        body { 
            /* Subtle Pattern Background same as PowerCon/Chemical */
            background-image: linear-gradient(rgba(240, 249, 246, 0.9), rgba(240, 249, 246, 0.9)), url('assets/bg.jpg');
            background-attachment: fixed;
            font-family: sans-serif; 
            min-h-screen; 
            padding-bottom: 160px; 
        }

        .glass-card { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(16, 185, 129, 0.1); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="text-slate-900">

    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-emerald-100 p-4 shadow-sm">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-xl font-black italic text-emerald-900 uppercase tracking-tighter leading-none">COAL<span class="text-emerald-500">DUMPING</span></h1>
                <p id="saveStatus" class="text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1 italic">All changes saved</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openHistory()" class="bg-emerald-600 text-white p-2.5 rounded-xl btn-tap shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" />
                    </svg>
                </button>
                <input type="date" id="logDate" onchange="loadDayData()" class="bg-emerald-50 border-none rounded-xl p-2 text-xs font-black text-emerald-700 outline-none">
            </div>
        </div>
    </div>

    <div class="max-w-lg mx-auto px-4 mt-4">
        <div class="bg-emerald-900 rounded-[2.5rem] p-6 text-white shadow-2xl shadow-emerald-200/50">
            <div class="flex justify-between items-center mb-4 text-[10px] font-black uppercase tracking-widest">
                <span class="text-emerald-400 italic">Plant Overview</span>
                <span id="activeYardBadge" class="bg-emerald-500 px-3 py-1 rounded-full text-[9px] font-black uppercase">---</span>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white/10 rounded-3xl p-4 border border-white/5">
                    <p class="text-[9px] font-black uppercase text-emerald-400 mb-1">Day Shift</p>
                    <div class="flex justify-between items-end">
                        <p id="dayBuckets" class="text-2xl font-black">0</p>
                        <p id="dayTapon" class="text-sm font-black text-emerald-300">0 <small class="text-[8px] opacity-50 uppercase">Tpn</small></p>
                    </div>
                </div>
                <div class="bg-white/10 rounded-3xl p-4 border border-white/5">
                    <p class="text-[9px] font-black uppercase text-blue-400 mb-1">Night Shift</p>
                    <div class="flex justify-between items-end">
                        <p id="nightBuckets" class="text-2xl font-black">0</p>
                        <p id="nightTapon" class="text-sm font-black text-blue-300">0 <small class="text-[8px] opacity-50 uppercase">Tpn</small></p>
                    </div>
                </div>
            </div>
            <div class="pt-4 border-t border-white/10">
                <p class="text-[8px] font-black uppercase text-emerald-500 mb-2 tracking-widest">Coalyard History Timeline</p>
                <div id="yardHistory" class="flex gap-2 overflow-x-auto no-scrollbar py-1 min-h-[30px]"></div>
            </div>
        </div>
    </div>

    <div class="flex mt-6 bg-white/50 backdrop-blur-sm p-1.5 rounded-2xl max-w-[280px] mx-auto border border-emerald-50 shadow-sm">
        <button onclick="switchBoiler('A')" id="tabA" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase transition-all bg-emerald-600 text-white shadow-md">Boiler A</button>
        <button onclick="switchBoiler('B')" id="tabB" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-emerald-600">Boiler B</button>
    </div>

    <div class="max-w-lg mx-auto p-4 mt-2">
        <div class="glass-card rounded-[2.5rem] overflow-hidden">
            <div class="grid grid-cols-4 bg-emerald-50/80 p-4 text-[9px] font-black text-emerald-800 uppercase tracking-widest text-center border-b border-emerald-100">
                <div>Time</div>
                <div>Buckets</div>
                <div>Tapon</div>
                <div>Coalyard</div>
            </div>
            <div id="logContainer" class="divide-y divide-emerald-50/50"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-emerald-100 p-5 z-40 shadow-[0_-10px_25px_rgba(0,0,0,0.05)]">
        <div class="max-w-lg mx-auto flex justify-between items-end">
            <div class="flex flex-col">
                <span id="footerLabel" class="text-[10px] font-black text-emerald-500 uppercase tracking-tighter italic">Boiler A Total</span>
                <div class="flex gap-4">
                    <p class="text-2xl font-black text-emerald-900"><span id="boilerTotalB">0</span> <small class="text-[10px] opacity-40 uppercase">Bkt</small></p>
                    <p class="text-2xl font-black text-slate-400"><span id="boilerTotalT">0</span> <small class="text-[10px] opacity-40 uppercase">Tpn</small></p>
                </div>
            </div>
            <button onclick="manualSave()" class="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black text-[11px] uppercase italic btn-tap shadow-xl shadow-emerald-200">Complete & Save</button>
        </div>
    </div>

    <div id="historyModal" class="fixed inset-0 bg-emerald-950/95 backdrop-blur-md z-[100] hidden flex flex-col">
        <div class="p-6 flex justify-between items-center text-white">
            <h2 class="text-xl font-black italic tracking-tighter uppercase">Master Archive</h2>
            <button onclick="closeHistory()" class="bg-white/10 p-2 rounded-full text-2xl leading-none">&times;</button>
        </div>
        <div class="px-6 pb-4">
            <input type="month" id="monthFilter" onchange="filterHistory()" class="w-full bg-white/10 border border-white/20 rounded-xl p-4 text-white font-black text-sm outline-none">
        </div>
        <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"></div>
    </div>

    <script>
        const yards = ["CY1", "CY2", "CY3", "CY4", "CY5", "CY6", "CY7", "CY8", "CY9"];
        const timeSlots = ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];
        
        let data = { A: {}, B: {} };
        let currentBoiler = 'A';
        let hasUnsavedChanges = false;

        function loadDayData() {
            const date = document.getElementById('logDate').value;
            const saved = localStorage.getItem(`coalData_${date}`);
            data = saved ? JSON.parse(saved) : { A: {}, B: {} };
            renderRows();
        }

        function switchBoiler(b) {
            currentBoiler = b;
            document.getElementById('tabA').className = b === 'A' ? "flex-1 py-2 rounded-xl font-black text-[10px] uppercase bg-emerald-600 text-white shadow-md" : "flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-emerald-600";
            document.getElementById('tabB').className = b === 'B' ? "flex-1 py-2 rounded-xl font-black text-[10px] uppercase bg-emerald-600 text-white shadow-md" : "flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-emerald-600";
            document.getElementById('footerLabel').innerText = `Boiler ${b} Total`;
            renderRows();
        }

        function renderRows() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
            const lastUsed = localStorage.getItem('lastUsedYard') || 'CY1';

            timeSlots.forEach(time => {
                if (!data[currentBoiler][time]) data[currentBoiler][time] = [{ buckets: 0, tapon: 0, yard: lastUsed }];
                
                data[currentBoiler][time].forEach((entry, idx) => {
                    const row = document.createElement('div');
                    row.className = `grid grid-cols-4 p-4 items-center text-center ${idx > 0 ? 'bg-emerald-50/50' : 'bg-white'}`;
                    row.innerHTML = `
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] font-black ${idx > 0 ? 'text-emerald-200' : 'text-emerald-900'}">${idx === 0 ? time : ''}</span>
                            ${idx === 0 ? `<button onclick="addSplit('${time}')" class="text-[7px] font-black uppercase text-emerald-500 mt-1">+ Split</button>` : ''}
                        </div>
                        
                        <div class="flex items-center justify-center gap-1">
                            <button onclick="updateVal('${time}',${idx},'buckets',-1)" class="w-6 h-6 bg-slate-100 text-slate-500 rounded-md font-black btn-tap">-</button>
                            <span class="w-4 text-[11px] font-black">${entry.buckets}</span>
                            <button onclick="updateVal('${time}',${idx},'buckets',1)" class="w-6 h-6 bg-emerald-600 text-white rounded-md font-black btn-tap shadow-sm">+</button>
                        </div>

                        <div class="flex items-center justify-center gap-1">
                            <button onclick="updateVal('${time}',${idx},'tapon',-1)" class="w-6 h-6 bg-slate-100 text-slate-400 rounded-md font-black btn-tap">-</button>
                            <span class="w-4 text-[11px] font-black">${entry.tapon}</span>
                            <button onclick="updateVal('${time}',${idx},'tapon',1)" class="w-6 h-6 bg-slate-700 text-white rounded-md font-black btn-tap shadow-sm">+</button>
                        </div>

                        <div class="flex items-center justify-between">
                            <select onchange="updateYard('${time}',${idx},this.value)" class="text-[10px] font-black bg-transparent outline-none w-full text-center">
                                ${yards.map(y => `<option value="${y}" ${entry.yard === y ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                            ${idx > 0 ? `<button onclick="removeSplit('${time}',${idx})" class="text-red-400 font-bold ml-1 text-lg">×</button>` : ''}
                        </div>
                    `;
                    container.appendChild(row);
                });
            });
            updateTotals();
        }

        function updateVal(time, idx, field, change) {
            data[currentBoiler][time][idx][field] = Math.max(0, data[currentBoiler][time][idx][field] + change);
            markUnsaved();
            renderRows();
        }

        function updateYard(time, idx, val) {
            data[currentBoiler][time][idx].yard = val;
            if (idx === 0) {
                localStorage.setItem('lastUsedYard', val);
                const startIdx = timeSlots.indexOf(time);
                ['A', 'B'].forEach(b => {
                    for (let i = startIdx; i < timeSlots.length; i++) {
                        const t = timeSlots[i];
                        if (!data[b][t]) data[b][t] = [{ buckets: 0, tapon: 0, yard: val }];
                        else data[b][t][0].yard = val;
                    }
                });
            }
            markUnsaved();
            renderRows();
        }

        function addSplit(time) {
            const curY = data[currentBoiler][time][0].yard;
            data[currentBoiler][time].push({ buckets: 0, tapon: 0, yard: curY });
            markUnsaved();
            renderRows();
        }

        function removeSplit(time, idx) {
            data[currentBoiler][time].splice(idx, 1);
            markUnsaved();
            renderRows();
        }

        function updateTotals() {
            let dB = 0, dT = 0, nB = 0, nT = 0, curB = 0, curT = 0, timelineArr = [], prevY = "";

            timeSlots.forEach(t => {
                const hour = parseInt(t.split(':')[0]);
                const mainYard = (data['A'][t] && data['A'][t][0]) ? data['A'][t][0].yard : "";
                if (mainYard && mainYard !== prevY) { timelineArr.push({ t, yard: mainYard }); prevY = mainYard; }

                ['A', 'B'].forEach(b => {
                    (data[b][t] || []).forEach(e => {
                        if (hour >= 6 && hour <= 17) { dB += e.buckets; dT += e.tapon; }
                        else { nB += e.buckets; nT += e.tapon; }
                        if (b === currentBoiler) { curB += e.buckets; curT += e.tapon; }
                    });
                });
            });

            document.getElementById('dayBuckets').innerText = dB;
            document.getElementById('dayTapon').innerText = dT;
            document.getElementById('nightBuckets').innerText = nB;
            document.getElementById('nightTapon').innerText = nT;
            document.getElementById('boilerTotalB').innerText = curB;
            document.getElementById('boilerTotalT').innerText = curT;
            document.getElementById('activeYardBadge').innerText = localStorage.getItem('lastUsedYard') || '---';
            
            document.getElementById('yardHistory').innerHTML = timelineArr.map(h => `
                <div class="flex items-center gap-1.5 min-w-fit">
                    <div class="bg-white/10 px-2 py-1 rounded-lg border border-white/5">
                        <p class="text-[6px] text-emerald-400 font-black">${h.t}</p>
                        <p class="text-[9px] font-black">${h.yard}</p>
                    </div>
                    <span class="text-white/20 text-[10px] last:hidden">→</span>
                </div>
            `).join('');
        }

        function markUnsaved() {
            hasUnsavedChanges = true;
            document.getElementById('saveStatus').innerText = "● Unsaved Changes...";
            document.getElementById('saveStatus').className = "text-[8px] font-black text-orange-500 uppercase tracking-widest mt-1 italic";
        }

        function manualSave() {
            const date = document.getElementById('logDate').value;
            localStorage.setItem(`coalData_${date}`, JSON.stringify(data));
            
            let tA_B = 0, tB_B = 0, yardsUsed = new Set();
            timeSlots.forEach(t => {
                (data['A'][t] || []).forEach(e => { tA_B += e.buckets; yardsUsed.add(e.yard); });
                (data['B'][t] || []).forEach(e => { tB_B += e.buckets; yardsUsed.add(e.yard); });
            });

            const record = { date, a_b: tA_B, b_b: tB_B, grandB: tA_B + tB_B, remarks: Array.from(yardsUsed).join('-') };
            let history = JSON.parse(localStorage.getItem('masterHistory') || '[]');
            history = history.filter(h => h.date !== date);
            history.unshift(record);
            localStorage.setItem('masterHistory', JSON.stringify(history));

            hasUnsavedChanges = false;
            document.getElementById('saveStatus').innerText = "✓ Successfully Saved!";
            document.getElementById('saveStatus').className = "text-[8px] font-black text-emerald-500 uppercase tracking-widest mt-1 italic";
            alert("Record Updated and Saved!");
            setTimeout(() => {
                document.getElementById('saveStatus').innerText = "All changes saved";
                document.getElementById('saveStatus').className = "text-[8px] font-black text-slate-400 uppercase tracking-widest mt-1 italic";
            }, 3000);
        }

        window.onbeforeunload = function() { if (hasUnsavedChanges) return "Unsaved changes exist!"; };
        function openHistory() { document.getElementById('historyModal').classList.remove('hidden'); filterHistory(); }
        function closeHistory() { document.getElementById('historyModal').classList.add('hidden'); }

        function filterHistory() {
            const filter = document.getElementById('monthFilter').value;
            const history = JSON.parse(localStorage.getItem('masterHistory') || '[]');
            const filtered = filter ? history.filter(h => h.date.startsWith(filter)) : history;
            document.getElementById('historyList').innerHTML = filtered.map(h => `
                <div class="bg-white rounded-[2rem] p-5 shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-black text-emerald-900">${h.date}</span>
                        <span class="bg-emerald-100 text-emerald-700 text-[8px] px-2 py-0.5 rounded-full font-black uppercase">${h.remarks}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-b border-slate-50 pb-4 mb-4 text-xs font-black">
                        <div class="text-slate-500 italic">Boiler A: <span class="text-slate-900">${h.a_b} Bkt</span></div>
                        <div class="text-slate-500 italic">Boiler B: <span class="text-slate-900">${h.b_b} Bkt</span></div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[9px] font-black text-emerald-600 uppercase">Grand Total</span>
                        <span class="text-lg font-black text-emerald-900">${h.grandB} <small class="text-[10px] opacity-40">Bkt</small></span>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('logDate').valueAsDate = new Date();
        document.getElementById('monthFilter').value = new Date().toISOString().slice(0, 7);
        loadDayData();
    </script>
</body>
</html>
