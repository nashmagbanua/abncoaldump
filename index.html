<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ABN-CoalDumping</title>
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .btn-tap:active { transform: scale(0.95); }
        ::-webkit-scrollbar { display: none; }
        body { background: #f8fafc; font-family: sans-serif; min-height: 100vh; }
        .page { display: none; min-height: 100vh; padding-bottom: 160px; }
        .active-page { display: block; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 2rem; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="text-slate-900">

    <div id="entryPage" class="page active-page">
        <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b p-4 shadow-sm">
            <div class="flex justify-between items-center max-w-lg mx-auto">
                <div>
                    <h1 class="text-xl font-black italic text-emerald-900 uppercase leading-none">COAL<span class="text-emerald-500">DUMPING</span></h1>
                    <p id="saveStatus" class="text-[8px] font-black text-slate-400 uppercase mt-1 italic">Ready to Log ?</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="showPage('archivePage')" class="bg-emerald-600 text-white p-2.5 rounded-xl btn-tap shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" /></svg>
                    </button>
                    <input type="date" id="logDate" onchange="loadDayData()" class="bg-emerald-50 border-none rounded-xl p-2 text-xs font-black text-emerald-700 outline-none">
                </div>
            </div>
        </div>

        <div class="max-w-lg mx-auto px-4 mt-4">
            <div class="bg-emerald-900 rounded-[2.5rem] p-6 text-white shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-[10px] font-black uppercase text-emerald-400 italic">Current Yards</span>
                    <span id="activeYardBadge" class="bg-emerald-500 px-4 py-1 rounded-full text-[9px] font-black uppercase tracking-wider">---</span>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-white/10 rounded-3xl p-4 text-center">
                        <p class="text-[9px] font-black uppercase text-emerald-400 mb-1">Day Shift</p>
                        <div class="flex justify-between items-end"><p id="dayBuckets" class="text-2xl font-black">0</p><p id="dayTapon" class="text-sm font-black text-emerald-300">0 <small class="text-[8px] opacity-50">Tpn</small></p></div>
                    </div>
                    <div class="bg-white/10 rounded-3xl p-4 text-center">
                        <p class="text-[9px] font-black uppercase text-blue-400 mb-1">Night Shift</p>
                        <div class="flex justify-between items-end"><p id="nightBuckets" class="text-2xl font-black">0</p><p id="nightTapon" class="text-sm font-black text-blue-300">0 <small class="text-[8px] opacity-50">Tpn</small></p></div>
                    </div>
                </div>
                <div id="dashboardNotesContainer" class="pt-4 border-t border-white/10 hidden">
                    <div id="dashboardNotes" class="text-[9px] font-mono text-emerald-200 uppercase leading-relaxed italic"></div>
                </div>
            </div>
        </div>

        <div class="flex mt-6 bg-slate-200/50 p-1.5 rounded-2xl max-w-[280px] mx-auto border border-white">
            <button onclick="switchBoiler('A')" id="tabA" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase transition-all bg-emerald-600 text-white shadow-md">Boiler A</button>
            <button onclick="switchBoiler('B')" id="tabB" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-emerald-600">Boiler B</button>
        </div>

        <div class="max-w-lg mx-auto p-4 mt-2">
            <div class="glass-card overflow-hidden">
                <div class="grid grid-cols-4 bg-emerald-50 p-4 text-[9px] font-black text-emerald-800 uppercase text-center border-b">
                    <div>Time</div><div>Buckets</div><div>Tapon</div><div>Yard</div>
                </div>
                <div id="logContainer" class="divide-y divide-slate-100"></div>
            </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-5 z-40 no-print">
            <div class="max-w-lg mx-auto flex justify-between items-end">
                <div>
                    <span id="footerLabel" class="text-[10px] font-black text-emerald-500 uppercase italic">Boiler A Total</span>
                    <div class="flex gap-4">
                        <p class="text-2xl font-black text-emerald-900"><span id="boilerTotalB">0</span> <small class="text-[10px] opacity-40 uppercase">Bkt</small></p>
                        <p class="text-2xl font-black text-slate-400"><span id="boilerTotalT">0</span> <small class="text-[10px] opacity-40 uppercase">Tpn</small></p>
                    </div>
                </div>
                <button onclick="manualSave()" class="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black text-[11px] uppercase italic btn-tap shadow-lg">Save Record</button>
            </div>
        </div>
    </div>

    <div id="archivePage" class="page">
        <div class="sticky top-0 z-50 bg-white border-b p-4 flex justify-between items-center no-print">
            <div class="flex items-center gap-3">
                <button onclick="showPage('entryPage')" class="bg-slate-100 p-2.5 rounded-xl text-slate-600 font-bold">‚Üê</button>
                <h2 class="text-xl font-black italic uppercase text-slate-800">Master <span class="text-emerald-500">Log</span></h2>
            </div>
            <input type="date" id="archiveDateFilter" onchange="filterHistory()" class="bg-slate-100 border-none rounded-xl p-2 text-xs font-black text-slate-700 outline-none">
        </div>

        <div class="max-w-lg mx-auto p-4">
            <div class="flex bg-slate-200/50 p-1.5 rounded-2xl mb-6 border border-white no-print">
                <button onclick="setShift('DAY')" id="btnDay" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase transition-all bg-emerald-600 text-white shadow-md">Day Shift</button>
                <button onclick="setShift('NIGHT')" id="btnNight" class="flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-slate-500">Night Shift</button>
            </div>
            <div id="historyList" class="space-y-6 pb-20"></div>
            <button onclick="window.print()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-[11px] uppercase italic mt-4 no-print shadow-lg">Print Report</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://qbeacrpoyfacgmbzxjcu.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFiZWFjcnBveWZhY2dtYnp4amN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2NTM5NTIsImV4cCI6MjA2NDIyOTk1Mn0.6kfxKLJxidW4BcqsMJte61AtzydrTW-1ZJIJytiUBt4";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        
        const yards = ["CY1", "CY2", "CY3", "CY4", "CY5", "CY6", "CY7", "CY8", "CY9"];
        const timeSlots = ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"];
        let data = { A: {}, B: {} };
        let currentBoiler = 'A';
        let currentShift = 'DAY';
        let hasUnsavedChanges = false;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
            document.getElementById(pageId).classList.add('active-page');
            if(pageId === 'archivePage') {
                document.getElementById('archiveDateFilter').value = document.getElementById('logDate').value;
                filterHistory();
            }
        }

        function setShift(shift) {
            currentShift = shift;
            document.getElementById('btnDay').className = shift === 'DAY' ? "flex-1 py-2 rounded-xl font-black text-[10px] uppercase bg-emerald-600 text-white shadow-md" : "flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-slate-500";
            document.getElementById('btnNight').className = shift === 'NIGHT' ? "flex-1 py-2 rounded-xl font-black text-[10px] uppercase bg-indigo-600 text-white shadow-md" : "flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-slate-500";
            filterHistory();
        }

        async function loadDayData() {
    const date = document.getElementById('logDate').value;
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.innerText = "‚è≥ Loading...";
    data = { A: {}, B: {} };
    const lastUsed = localStorage.getItem('lastUsedYard') || 'CY1';

    try {
        const { data: dbLogs, error } = await supabaseClient
            .from('daily_bucket_logs')
            .select('*')
            .eq('log_date', date)
            .order('created_at', { ascending: true }); // Ginagamit ang created_at para sa tamang sequence

        if (error) throw error;

        if (dbLogs && dbLogs.length > 0) {
            dbLogs.forEach(log => {
                if (!data[log.boiler][log.time_slot]) data[log.boiler][log.time_slot] = [];
                data[log.boiler][log.time_slot].push({
                    buckets: log.buckets_used,
                    tapon: log.tapon_count || 0,
                    yard: log.yard_no
                });
            });
        }

        // Fill empty slots
        ['A', 'B'].forEach(b => {
            timeSlots.forEach(t => {
                if (!data[b][t] || data[b][t].length === 0) {
                    data[b][t] = [{ buckets: 0, tapon: 0, yard: lastUsed }];
                }
            });
        });

        saveStatus.innerText = "‚úì Database Synced";
        saveStatus.className = "text-[8px] font-black text-emerald-500 mt-1 italic";
        hasUnsavedChanges = false;
    } catch (err) {
        console.error("Load Error:", err);
        saveStatus.innerText = "‚ö†Ô∏è Offline Mode";
    }
    renderRows(); 
}

        function switchBoiler(b) {
            currentBoiler = b;
            document.getElementById('tabA').className = b === 'A' ? "flex-1 py-2 rounded-xl font-black text-[10px] uppercase bg-emerald-600 text-white shadow-md" : "flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-emerald-600";
            document.getElementById('tabB').className = b === 'B' ? "flex-1 py-2 rounded-xl font-black text-[10px] uppercase bg-emerald-600 text-white shadow-md" : "flex-1 py-2 rounded-xl font-black text-[10px] uppercase text-emerald-600";
            document.getElementById('footerLabel').innerText = `Boiler ${b} Total`;
            renderRows();
        }

        function renderRows() {
            const container = document.getElementById('logContainer');
            container.innerHTML = '';
            timeSlots.forEach(time => {
                data[currentBoiler][time].forEach((entry, idx) => {
                    const row = document.createElement('div');
                    row.className = `grid grid-cols-4 p-4 items-center text-center ${idx > 0 ? 'bg-slate-50' : 'bg-white'}`;
                    row.innerHTML = `
                        <div><span class="text-[10px] font-black ${idx > 0 ? 'text-slate-300' : 'text-slate-800'}">${idx === 0 ? time : ''}</span>
                        ${idx === 0 ? `<br><button onclick="addSplit('${time}')" class="text-[7px] font-black uppercase text-emerald-500 tracking-tighter">+ SPLIT YARD</button>` : ''}</div>
                        <div class="flex items-center justify-center gap-1"><button onclick="updateVal('${time}',${idx},'buckets',-1)" class="w-6 h-6 bg-slate-100 rounded text-slate-500">-</button><span class="w-4 text-[11px] font-black">${entry.buckets}</span><button onclick="updateVal('${time}',${idx},'buckets',1)" class="w-6 h-6 bg-emerald-600 text-white rounded shadow-sm">+</button></div>
                        <div class="flex items-center justify-center gap-1"><button onclick="updateVal('${time}',${idx},'tapon',-1)" class="w-6 h-6 bg-slate-100 rounded text-slate-400">-</button><span class="w-4 text-[11px] font-black">${entry.tapon}</span><button onclick="updateVal('${time}',${idx},'tapon',1)" class="w-6 h-6 bg-slate-700 text-white rounded shadow-sm">+</button></div>
                        <div class="flex items-center justify-between"><select onchange="updateYard('${time}',${idx},this.value)" class="text-[10px] font-black bg-transparent outline-none w-full text-center">${yards.map(y => `<option value="${y}" ${entry.yard === y ? 'selected' : ''}>${y}</option>`).join('')}</select>${idx > 0 ? `<button onclick="removeSplit('${time}',${idx})" class="text-red-400 font-bold ml-1">√ó</button>` : ''}</div>`;
                    container.appendChild(row);
                });
            });
            updateTotals();
        }

        function updateVal(t, i, f, c) { data[currentBoiler][t][i][f] = Math.max(0, data[currentBoiler][t][i][f] + c); markUnsaved(); renderRows(); }
        
        function addSplit(t) { 
            ['A', 'B'].forEach(b => data[b][t].push({ buckets: 0, tapon: 0, yard: data[b][t][0].yard })); 
            markUnsaved(); renderRows(); 
        }
        
        function removeSplit(t, i) { 
            ['A', 'B'].forEach(b => data[b][t].splice(i, 1)); 
            markUnsaved(); renderRows(); 
        }

        function updateYard(time, idx, val) {
    // Boiler A lang muna ang i-update natin para siguradong walang spread
    data[currentBoiler][time][idx].yard = val;
    
    // I-sync sa kabila kung idx 0 (Main Row)
    if (idx === 0) {
        const otherBoiler = currentBoiler === 'A' ? 'B' : 'A';
        if (data[otherBoiler][time]) {
            data[otherBoiler][time][0].yard = val;
        }
    }

    localStorage.setItem('lastUsedYard', val);
    markUnsaved(); 
    renderRows();
}
        function updateTotals() {
            let dB = 0, dT = 0, nB = 0, nT = 0, curB = 0, curT = 0;
            let yardsUsed = new Set();
            let timeline = []; // FIXED: Defined na ang timeline dito

            timeSlots.forEach(t => {
                const hour = parseInt(t.split(':')[0]);
                ['A', 'B'].forEach(b => {
                    if (data[b][t]) {
                        data[b][t].forEach(e => {
                            if (hour >= 6 && hour <= 17) { dB += e.buckets; dT += e.tapon; } 
                            else { nB += e.buckets; nT += e.tapon; }

                            if (b === currentBoiler) { 
                                curB += e.buckets; curT += e.tapon; 
                                if (e.buckets > 0) {
                                    if (timeline.length === 0 || timeline[timeline.length - 1].yard !== e.yard) {
                                        timeline.push({ t: t, yard: e.yard });
                                    }
                                }
                            }
                            if (e.buckets > 0) yardsUsed.add(e.yard);
                        });
                    }
                });
            });

            document.getElementById('activeYardBadge').innerText = yardsUsed.size > 0 ? Array.from(yardsUsed).join(' - ') : "---";
            document.getElementById('dayBuckets').innerText = dB; 
            document.getElementById('dayTapon').innerText = dT;
            document.getElementById('nightBuckets').innerText = nB; 
            document.getElementById('nightTapon').innerText = nT;
            document.getElementById('boilerTotalB').innerText = curB; 
            document.getElementById('boilerTotalT').innerText = curT;

            const notesCont = document.getElementById('dashboardNotesContainer');
            const notesDiv = document.getElementById('dashboardNotes');

            if (yardsUsed.size > 1 && timeline.length > 1) {
                notesCont.classList.remove('hidden');
                let nText = "";
                for (let i = 1; i < timeline.length; i++) {
                    nText += `Note: ${timeline[i-1].yard} END - ${timeline[i].t} | ${timeline[i].yard} START - ${timeline[i].t}<br>`;
                }
                notesDiv.innerHTML = nText;
            } else { notesCont.classList.add('hidden'); }
        }

        function markUnsaved() {
            hasUnsavedChanges = true;
            document.getElementById('saveStatus').innerText = "‚óè Unsaved Changes";
            document.getElementById('saveStatus').className = "text-[8px] font-black text-orange-500 mt-1 italic";
        }

        async function manualSave() {
    const date = document.getElementById('logDate').value;
    const saveStatus = document.getElementById('saveStatus');

    saveStatus.innerText = "‚è≥ Cleaning & Saving to Cloud...";
    saveStatus.className = "text-[8px] font-black text-blue-500 mt-1 italic";

    const logsToUpload = [];

    // 1. Ipunin lahat ng entries mula sa data object (A at B)
    ['A', 'B'].forEach(boiler => {
        Object.keys(data[boiler]).forEach(time => {
            data[boiler][time].forEach(entry => {
                // Isasama lang natin ang mga may buckets o may tapon para hindi mapuno ang DB ng puro zero
                if (entry.buckets > 0 || entry.tapon > 0) {
                    logsToUpload.push({
                        log_date: date,
                        time_slot: time,
                        boiler: boiler,
                        buckets_used: Number(entry.buckets) || 0,
                        tapon_count: Number(entry.tapon) || 0,
                        yard_no: entry.yard,
                        kg_estimated: (Number(entry.buckets) || 0) * 200,
                        is_finalized: false // default field kung meron ka nito
                    });
                }
            });
        });
    });

    try {
        // 2. üßπ DELETE: Burahin ang lahat ng luma para sa petsang ito
        const { error: deleteError } = await supabaseClient
            .from('daily_bucket_logs')
            .delete()
            .eq('log_date', date);

        if (deleteError) throw deleteError;

        // 3. ‚ûï INSERT: Kung may bagong data, i-pasok lahat
        if (logsToUpload.length > 0) {
            const { error: insertError } = await supabaseClient
                .from('daily_bucket_logs')
                .insert(logsToUpload);

            if (insertError) throw insertError;
        }

        hasUnsavedChanges = false;
        saveStatus.innerText = "‚úì Synced Cleanly";
        saveStatus.className = "text-[8px] font-black text-emerald-500 mt-1 italic";
        alert("Record Successfully Saved & Synced!");

    } catch (err) {
        console.error("Save Error:", err);
        saveStatus.innerText = "‚ö†Ô∏è Save Failed";
        saveStatus.className = "text-[8px] font-black text-red-500 mt-1 italic";
        alert("Save Failed! Check your internet or Supabase connection.");
    }
}

        async function filterHistory() {
            const selDate = document.getElementById('archiveDateFilter').value || document.getElementById('logDate').value;
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<p class="text-center p-10 text-[10px] font-black uppercase text-slate-400 italic">Fetching Cloud Data...</p>';

            try {
                const { data: dbLogs, error } = await supabaseClient.from('daily_bucket_logs').select('*').eq('log_date', selDate).order('time_slot', { ascending: true });
                if (error) throw error;
                let filteredRows = [];
                let yardsUsed = new Set();
                dbLogs.forEach(log => {
                    const hour = parseInt(log.time_slot.split(':')[0]);
                    const isDay = hour >= 6 && hour <= 17;
                    if ((currentShift === 'DAY' && isDay) || (currentShift === 'NIGHT' && !isDay)) {
                        if (log.buckets_used > 0 || log.tapon_count > 0) {
                            filteredRows.push({ t: log.time_slot, b: log.boiler, bkt: log.buckets_used, tpn: log.tapon_count, yard: log.yard_no });
                            yardsUsed.add(log.yard_no);
                        }
                    }
                });
                renderArchiveUI(selDate, filteredRows, yardsUsed);
            } catch (err) { historyList.innerHTML = '<p>Error loading data.</p>'; }
        }

        function renderArchiveUI(selDate, filteredRows, yardsUsed) {
    const grandTotalBkt = filteredRows.reduce((sum, r) => sum + (r.bkt || 0), 0);
    const grandTotalTpn = filteredRows.reduce((sum, r) => sum + (r.tpn || 0), 0);
    
    // Check kung may rows, kung wala, ipakita ang "No Records"
    const rowsHTML = filteredRows.length > 0 
        ? filteredRows.map(r => `<tr><td class="p-3 font-bold">${r.t}</td><td class="p-3 text-center">${r.b}</td><td class="p-3 text-center font-black">${r.bkt}</td><td class="p-3 text-center text-slate-300">${r.tpn}</td><td class="p-3 text-right font-black text-emerald-600">${r.yard}</td></tr>`).join('')
        : `<tr><td colspan="5" class="p-10 text-center italic text-slate-400">No records found for this shift.</td></tr>`;

    const tableHTML = `
        <div class="bg-white rounded-3xl overflow-hidden mb-4 border border-slate-200 shadow-sm">
            <div class="${currentShift === 'DAY' ? 'bg-emerald-600' : 'bg-indigo-600'} text-white px-4 py-3 text-[10px] font-black uppercase tracking-widest text-center">
                ${currentShift} SHIFT LOG
            </div>
            <table class="w-full text-[10px] text-left">
                <thead class="bg-slate-50 border-b">
                    <tr><th class="p-3">TIME</th><th class="p-3 text-center">BLR</th><th class="p-3 text-center">BKT</th><th class="p-3 text-center">TPN</th><th class="p-3 text-right">YARD</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    ${rowsHTML}
                </tbody>
            </table>
        </div>`;
        
    document.getElementById('historyList').innerHTML = `
        <div class="bg-slate-900 rounded-[2rem] p-5 text-white mb-6 border-b-4 border-emerald-500 shadow-lg">
            <p class="text-[9px] font-black text-emerald-400 uppercase tracking-widest mb-1">Grand Total (${selDate})</p>
            <div class="flex justify-between items-end">
                <h3 class="text-3xl font-black">${grandTotalBkt.toLocaleString()} <small class="text-xs opacity-50">BKT</small></h3>
                <p class="text-xl font-black text-slate-400">${grandTotalTpn} <small class="text-xs opacity-50">TPN</small></p>
            </div>
        </div>
        ${tableHTML}`;
}

        window.onbeforeunload = function() { if (hasUnsavedChanges) return "Unsaved changes exist!"; };
        const phTime = new Date().toLocaleDateString('en-CA', {timeZone: 'Asia/Manila'}); 
        document.getElementById('logDate').value = phTime;
        loadDayData();
    </script>
</body>
</html>
